<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>RPi GPIO</title>
        <script src="javascripts/jquery-1.7.1.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
        <script>
            $(function() {
				console.log("GPIO PubSub");
				
				var gpioPinIds = [0,1,4,7,8,9,10,11,14,15,17,18,21,22,23,24,25];
				var gpios = [];
				var deviceId = "myDevice";

				for(var i=0; i<gpioPinIds.length; i++){
					var pinId = gpioPinIds[i];
					
					var g = {
						id: pinId,
						div : $('<div></div>'),
						label : $('<span></span>'),
						inOutSelect : $('<select></select>'),
						valCheckbox : $('<input type="checkbox"></checkbox>'),
						valKey : deviceId+':gpio:'+pinId+':value',
						dirKey : deviceId+':gpio:'+pinId+':direction'
					};
					
					gpios[pinId] = g;
					
					function inOutSelectChanged(){
						var a = g;
						return function(){
							socket.emit('pub',[{
								key:a.dirKey,
								value:a.inOutSelect.val()
							}]);
						};
					}
					
					$('body').append(g.div);
					g.div.append(g.label);
					
					// create label
					g.label.html(pinId);
					
					// create in/out select
					g.div.append(g.inOutSelect);
					g.inOutSelect.append('<option value="in">in</option>');
					g.inOutSelect.append('<option value="out">out</option>');
					g.inOutSelect.change(inOutSelectChanged());
					//
					
					// create value checkbox
					g.div.append(g.valCheckbox);
					//g.valCheckbox.attr('checked',d.val == 1);
					
					function valCheckboxChanged(){
						var a = g;
						return function(){
							socket.emit('pub',[{
								key:a.valKey,
								value:a.valCheckbox.attr('checked') == 'checked' ? 1 : 0
							}]);
						};
					}
					g.valCheckbox.change(valCheckboxChanged());
				}

			
				/*
				function sendGPIO(a){
					var g = {pin:a.id,dir:a.inOutSelect.val(),val:a.valCheckbox.attr('checked') == 'checked' ? 1 : 0};
					socket.emit("gpio",g);
				}
				*/
				
				function gpioDataReceived(data){
					console.log('msg: ' + data.key + ' > ' + data.value);
					
					var s = data.key.split(':');
					if(s[0] === deviceId){
						if(s[1] === 'gpio'){
							var pinId = Number(s[2]);
							var g = gpios[pinId];
							if(s[3] === 'value'){
								g.valCheckbox.attr('checked',data.value == "1");
							} else if(s[3] === 'direction'){
								g.inOutSelect.val(data.value);
							}
						}
					}
				}
				
				// setup socket
				var socket = io.connect('http://'+window.location.host+'/browser');
				
				socket.on('connect',function(){
					for(var i=0; i<gpioPinIds.length; i++){
						var g = gpios[gpioPinIds[i]];
						socket.emit('get',g.valKey);
						socket.emit('get',g.dirKey);
						socket.emit('sub',[g.valKey,g.dirKey]);	
					}
				});
				
				socket.on('get', gpioDataReceived);
				socket.on('msg', gpioDataReceived);
				
				/*
				socket.on('gpio', function (data) {
					console.log("gpio");
					console.log(data);
				
					if(!inited){
						initialize(data);
						inited  = true;
					} else {
						// update ui
						for(var i=0; i<data.length; i++){
							var d = data[i];
							var g = gpios[d.pin];
							// create in/out select
							g.inOutSelect.val(d.dir);
							g.valCheckbox.attr('checked',d.val == 1);
						}
					}
				});
				*/
            });
        </script> 
        <style>
        	body {
        		padding: 10px;
        	}
        	button {
        		width: 200px;
        		height: 25px;
        		margin: 5px;
        	}
        </style>
    </head>
    <body>
    </body>
</html>
